<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pagecraft ‚Äî HTML Page Publisher</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #07070a;
    --surface: #0e0e12;
    --surface2: #13131a;
    --border: #1e1e28;
    --border2: #2a2a38;
    --gold: #c9a84c;
    --gold2: #a07830;
    --text: #e2ddd4;
    --text2: #9a9488;
    --text3: #4a4840;
    --red: #c0392b;
    --green: #27ae60;
    --admin-accent: #7c3aed;
    --admin-light: #a78bfa;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background:
      radial-gradient(ellipse 70% 50% at 15% 10%, rgba(201,168,76,0.05) 0%, transparent 55%),
      radial-gradient(ellipse 50% 70% at 85% 85%, rgba(124,58,237,0.04) 0%, transparent 55%);
    pointer-events: none;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  nav {
    position: sticky; top: 0; z-index: 200;
    height: 58px;
    background: rgba(7,7,10,0.92);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 28px;
  }
  .nav-logo { display: flex; align-items: center; gap: 10px; cursor: pointer; }
  .nav-logo-icon {
    width: 30px; height: 30px; border-radius: 7px;
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif;
    font-size: 16px; color: #07070a;
  }
  .nav-logo-text { font-family: 'Playfair Display', serif; font-size: 17px; letter-spacing: 0.1em; color: var(--gold); }
  .nav-actions { display: flex; gap: 10px; align-items: center; }

  .admin-badge-nav {
    display: flex; align-items: center; gap: 6px;
    background: rgba(124,58,237,0.15);
    border: 1px solid rgba(124,58,237,0.4);
    border-radius: 20px; padding: 4px 12px;
    font-size: 11px; color: var(--admin-light);
    letter-spacing: 0.08em;
  }
  .admin-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--admin-light); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .btn-primary {
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    color: #07070a; border: none; border-radius: 6px;
    padding: 9px 20px; cursor: pointer;
    font-family: 'DM Mono', monospace; font-size: 13px;
    letter-spacing: 0.06em; transition: all 0.15s;
  }
  .btn-primary:hover { filter: brightness(1.15); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(201,168,76,0.25); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-ghost {
    background: transparent; color: var(--text2);
    border: 1px solid var(--border2); border-radius: 6px;
    padding: 8px 18px; cursor: pointer;
    font-family: 'DM Mono', monospace; font-size: 13px;
    letter-spacing: 0.04em; transition: all 0.15s;
  }
  .btn-ghost:hover { border-color: var(--text3); color: var(--text); }

  .btn-icon {
    background: none; border: none; cursor: pointer;
    padding: 6px 8px; border-radius: 5px;
    font-size: 14px; transition: background 0.15s;
    color: var(--text3);
  }
  .btn-icon:hover { background: rgba(255,255,255,0.05); color: var(--text2); }
  .btn-icon.danger { color: #7a3030; }
  .btn-icon.danger:hover { background: rgba(192,57,43,0.1); color: #e74c3c; }

  main { position: relative; z-index: 1; max-width: 1080px; margin: 0 auto; padding: 40px 28px 80px; }
  .view { display: none; }
  .view.active { display: block; }

  .page-header { margin-bottom: 36px; }
  .page-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 30px; font-weight: 400; color: #ddd8cc;
    letter-spacing: 0.03em; margin-bottom: 6px;
  }
  .page-header p { color: var(--text3); font-size: 13px; letter-spacing: 0.04em; }

  .empty-state {
    border: 1px dashed var(--border2); border-radius: 14px;
    padding: 80px 40px; text-align: center; color: var(--text3);
  }
  .empty-state .icon { font-size: 44px; margin-bottom: 16px; }
  .empty-state h3 { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 400; color: var(--text2); margin-bottom: 8px; }
  .empty-state p { font-size: 13px; margin-bottom: 24px; }

  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 18px; }

  .page-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    animation: fadeUp 0.3s ease both;
  }
  .page-card:hover { transform: translateY(-3px); box-shadow: 0 16px 48px rgba(0,0,0,0.6); border-color: var(--border2); }

  .card-preview { height: 140px; background: #050508; overflow: hidden; position: relative; cursor: pointer; }
  .card-preview iframe { width: 200%; height: 200%; transform: scale(0.5); transform-origin: 0 0; border: none; pointer-events: none; }
  .card-preview-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 50%, var(--surface)); }

  .card-body { padding: 14px 18px 18px; }
  .card-title-row { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
  .card-title { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 400; color: #d8d2c0; flex: 1; line-height: 1.4; }
  .card-actions { display: flex; gap: 2px; }

  .url-block { margin-bottom: 12px; }
  .url-row {
    display: flex; align-items: center; gap: 8px;
    background: #09090d; border-radius: 6px;
    padding: 7px 10px;
    border: 1px solid var(--border);
  }
  .url-text { flex: 1; font-size: 11px; color: var(--text3); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .copy-btn {
    background: none; border: none; cursor: pointer;
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--gold); padding: 0; white-space: nowrap; transition: color 0.15s;
  }
  .copy-btn:hover { color: #e8c870; }
  .copy-btn.copied { color: #55efc4 !important; }

  .card-footer-btns { display: flex; gap: 8px; }
  .card-footer-btns button { flex: 1; padding: 7px 0; font-size: 12px; }
  .card-date { margin-top: 10px; font-size: 11px; color: var(--text3); }

  .add-card {
    border: 1px dashed var(--border); border-radius: 12px;
    min-height: 280px; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    cursor: pointer; color: var(--text3); transition: all 0.2s;
  }
  .add-card:hover { border-color: var(--text3); color: var(--text2); background: rgba(255,255,255,0.01); }
  .add-card .plus { font-size: 28px; margin-bottom: 8px; }
  .add-card span { font-size: 12px; letter-spacing: 0.06em; }

  .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; }
  @media (max-width: 700px) { .editor-grid { grid-template-columns: 1fr; } }

  .form-group { margin-bottom: 20px; }
  .form-label { display: block; margin-bottom: 8px; font-size: 11px; color: var(--text2); letter-spacing: 0.1em; text-transform: uppercase; }
  .form-label span { color: var(--text3); text-transform: none; font-size: 10px; }

  input[type="text"], textarea {
    width: 100%;
    background: var(--surface2); color: var(--text);
    border: 1px solid var(--border2); border-radius: 7px;
    font-family: 'DM Mono', monospace; font-size: 13px;
    padding: 10px 14px; outline: none; transition: border-color 0.15s;
  }
  input[type="text"]:focus, textarea:focus { border-color: var(--gold); }

  .slug-row {
    display: flex; align-items: stretch;
    background: var(--surface2); border: 1px solid var(--border2);
    border-radius: 7px; overflow: hidden; transition: border-color 0.15s;
  }
  .slug-row:focus-within { border-color: var(--gold); }
  .slug-prefix { padding: 10px 12px; font-size: 12px; color: var(--text3); border-right: 1px solid var(--border2); white-space: nowrap; display: flex; align-items: center; }
  .slug-row input { border: none; border-radius: 0; background: transparent; padding: 10px 12px; flex: 1; }
  .slug-row input:focus { border-color: transparent; }

  .dropzone { border: 2px dashed var(--border2); border-radius: 10px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
  .dropzone.drag-over { border-color: var(--gold); background: rgba(201,168,76,0.04); }
  .dropzone:hover { border-color: var(--text3); }
  .dropzone input[type="file"] { display: none; }
  .dropzone-icon { font-size: 30px; margin-bottom: 10px; color: var(--text3); }
  .dropzone.drag-over .dropzone-icon { color: var(--gold); }
  .dropzone-label { font-size: 13px; color: var(--text2); margin-bottom: 4px; }
  .dropzone-sub { font-size: 11px; color: var(--text3); }

  textarea#html-input { height: 340px; resize: vertical; font-size: 12px; line-height: 1.7; }
  .editor-actions { margin-top: 28px; display: flex; gap: 12px; justify-content: flex-end; }

  .admin-key-box {
    background: rgba(124,58,237,0.08);
    border: 1px solid rgba(124,58,237,0.35);
    border-radius: 10px; padding: 20px 22px; margin-bottom: 28px;
    display: none;
  }
  .admin-key-box.show { display: block; animation: fadeUp 0.3s ease; }
  .admin-key-title {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--admin-light);
    letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 14px;
  }
  .admin-key-shield { font-size: 16px; }
  .admin-urls { display: flex; flex-direction: column; gap: 10px; }
  .admin-url-item { display: flex; flex-direction: column; gap: 4px; }
  .admin-url-label { font-size: 10px; color: var(--text3); letter-spacing: 0.08em; text-transform: uppercase; }
  .admin-url-value {
    display: flex; align-items: center; gap: 8px;
    background: #09090d; border-radius: 6px;
    padding: 9px 12px; border: 1px solid var(--border);
  }
  .admin-url-value.admin-val { border-color: rgba(124,58,237,0.3); background: rgba(124,58,237,0.05); }
  .admin-url-text { flex: 1; font-size: 12px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; word-break: break-all; }
  .admin-url-text.purple { color: rgba(167,139,250,0.8); }
  .admin-note { margin-top: 12px; font-size: 11px; color: var(--text3); line-height: 1.6; }
  .admin-note strong { color: rgba(167,139,250,0.7); }

  .preview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .preview-title { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 400; color: var(--gold); margin-bottom: 4px; }
  .preview-url { font-size: 12px; color: var(--text3); }

  .browser-shell { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .browser-chrome {
    background: var(--surface); padding: 10px 16px;
    display: flex; align-items: center; gap: 12px;
    border-bottom: 1px solid var(--border);
  }
  .browser-dots { display: flex; gap: 6px; }
  .browser-dots span { width: 10px; height: 10px; border-radius: 50%; }
  .browser-url-bar { flex: 1; background: #07070a; border: 1px solid var(--border); border-radius: 5px; padding: 5px 12px; font-size: 12px; color: var(--text3); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .browser-frame { width: 100%; height: 580px; border: none; display: block; background: #fff; }

  #view-public { max-width: 100%; padding: 0; margin: 0; position: fixed; inset: 0; z-index: 300; }
  .public-frame { width: 100%; height: 100vh; border: none; display: block; }

  .modal-overlay {
    position: fixed; inset: 0; z-index: 999;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: auto; }
  .modal {
    background: var(--surface); border: 1px solid var(--border2);
    border-radius: 14px; padding: 32px; width: 90%; max-width: 480px;
    transform: translateY(10px); transition: transform 0.2s;
  }
  .modal-overlay.show .modal { transform: translateY(0); }
  .modal h2 { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 400; color: var(--text); margin-bottom: 8px; }
  .modal p { font-size: 13px; color: var(--text2); margin-bottom: 24px; line-height: 1.6; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

  #toast {
    position: fixed; top: 20px; right: 20px; z-index: 9999;
    padding: 12px 20px; border-radius: 8px;
    font-size: 13px; letter-spacing: 0.04em;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    opacity: 0; pointer-events: none; transform: translateY(-8px);
    transition: all 0.25s;
  }
  #toast.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
  #toast.success { background: #0e2018; border: 1px solid #1e8a50; color: #55efc4; }
  #toast.error { background: #20100e; border: 1px solid #8a2020; color: #ff7675; }
  #toast.info { background: #100e20; border: 1px solid rgba(124,58,237,0.6); color: var(--admin-light); }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<nav>
  <div class="nav-logo" onclick="goHome()">
    <div class="nav-logo-icon">P</div>
    <span class="nav-logo-text">PAGECRAFT</span>
  </div>
  <div class="nav-actions" id="nav-actions">
    <button class="btn-primary" onclick="openNew()">+ New Page</button>
  </div>
</nav>

<div id="toast"></div>

<div class="modal-overlay" id="confirm-modal">
  <div class="modal">
    <h2 id="modal-title">Confirm Delete</h2>
    <p id="modal-body">Are you sure you want to delete this page? This cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" style="background:linear-gradient(135deg,#c0392b,#922b21);color:#fff" id="modal-confirm-btn">Delete</button>
    </div>
  </div>
</div>

<main>
  <div id="view-dashboard" class="view active">
    <div class="page-header">
      <h1>Your Pages</h1>
      <p>Upload HTML ¬∑ Assign a unique URL ¬∑ Share with the world</p>
    </div>
    <div class="grid" id="pages-grid"></div>
  </div>

  <div id="view-editor" class="view">
    <div class="page-header">
      <h1 id="editor-heading">Create New Page</h1>
      <p id="editor-subheading">Paste or upload HTML, set a URL slug, then publish.</p>
    </div>

    <div class="admin-key-box" id="admin-key-box">
      <div class="admin-key-title"><span class="admin-key-shield">üîê</span> Save Your Admin URL</div>
      <div class="admin-urls">
        <div class="admin-url-item">
          <div class="admin-url-label">Public URL ‚Äî share this</div>
          <div class="admin-url-value">
            <span class="admin-url-text" id="akb-public">‚Äî</span>
            <button class="copy-btn" onclick="copyText(document.getElementById('akb-public').textContent, this)">Copy</button>
          </div>
        </div>
        <div class="admin-url-item">
          <div class="admin-url-label">Admin URL ‚Äî keep this private</div>
          <div class="admin-url-value admin-val">
            <span class="admin-url-text purple" id="akb-admin">‚Äî</span>
            <button class="copy-btn" onclick="copyText(document.getElementById('akb-admin').textContent, this)">Copy</button>
          </div>
        </div>
      </div>
      <div class="admin-note">
        ‚ö†Ô∏è <strong>Save your Admin URL now.</strong> It contains a secret token ‚Äî anyone with it can edit or delete this page.
      </div>
    </div>

    <div class="editor-grid">
      <div>
        <div class="form-group">
          <label class="form-label">Page Title</label>
          <input type="text" id="inp-title" placeholder="My Awesome Page">
        </div>
        <div class="form-group">
          <label class="form-label">URL Slug <span>(auto-generated if empty)</span></label>
          <div class="slug-row">
            <span class="slug-prefix" id="slug-prefix">yoursite.com/</span>
            <input type="text" id="inp-slug" placeholder="my-page-abc12" oninput="sanitizeSlug(this)">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Upload HTML File</label>
          <div class="dropzone" id="dropzone"
            onclick="document.getElementById('file-input').click()"
            ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
            <input type="file" id="file-input" accept=".html,.htm" onchange="onFileSelect(event)">
            <div class="dropzone-icon">‚á™</div>
            <div class="dropzone-label">Drop your .html file here</div>
            <div class="dropzone-sub">or click to browse</div>
          </div>
        </div>
      </div>
      <div>
        <div class="form-group" style="height:100%">
          <label class="form-label">HTML Code</label>
          <textarea id="html-input" placeholder="<!DOCTYPE html>
<html>
  <head><title>My Page</title></head>
  <body>
    <h1>Hello World!</h1>
  </body>
</html>"></textarea>
        </div>
      </div>
    </div>

    <div class="editor-actions">
      <button class="btn-ghost" onclick="goHome()">Cancel</button>
      <button class="btn-ghost" onclick="previewFromEditor()">Preview</button>
      <button class="btn-primary" id="btn-save" onclick="savePageFromEditor()">Publish Page</button>
    </div>
  </div>

  <div id="view-preview" class="view">
    <div class="preview-header">
      <div>
        <div class="preview-title" id="preview-title-label">‚Äî</div>
        <div class="preview-url" id="preview-url-label">‚Äî</div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn-ghost" id="btn-edit-from-preview" onclick="editFromPreview()" style="display:none">Edit</button>
        <button class="btn-ghost" onclick="goHome()">‚Üê Dashboard</button>
      </div>
    </div>
    <div class="browser-shell">
      <div class="browser-chrome">
        <div class="browser-dots">
          <span style="background:#c0392b"></span>
          <span style="background:#f39c12"></span>
          <span style="background:#27ae60"></span>
        </div>
        <div class="browser-url-bar" id="browser-url">‚Äî</div>
      </div>
      <iframe class="browser-frame" id="preview-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation-by-user-activation"></iframe>
    </div>
  </div>

  <div id="view-public" class="view" style="margin:0;padding:0;max-width:100%;position:fixed;inset:0;z-index:300">
    <iframe class="public-frame" id="public-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation-by-user-activation"></iframe>
  </div>
</main>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_URL = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000/api'
  : '/api'; // Change this to your deployed backend URL

const BASE_URL = window.location.origin + window.location.pathname.replace(/index\.html$/, '');

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pages = [];
let editingId = null;
let editingToken = null;
let previewPageId = null;

// ‚îÄ‚îÄ‚îÄ API CALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchPages() {
  try {
    const res = await fetch(`${API_URL}/pages`);
    const data = await res.json();
    if (data.success) {
      pages = data.pages;
      return true;
    }
    return false;
  } catch (e) {
    console.error('Error fetching pages:', e);
    showToast('Failed to load pages', 'error');
    return false;
  }
}

async function fetchPage(slug) {
  try {
    const res = await fetch(`${API_URL}/page/${slug}`);
    const data = await res.json();
    return data.success ? data.page : null;
  } catch (e) {
    console.error('Error fetching page:', e);
    return null;
  }
}

async function fetchPageWithAuth(slug, token) {
  try {
    const res = await fetch(`${API_URL}/page/${slug}/${token}`);
    const data = await res.json();
    return data.success ? data.page : null;
  } catch (e) {
    console.error('Error fetching page with auth:', e);
    return null;
  }
}

async function createPage(pageData) {
  try {
    const res = await fetch(`${API_URL}/pages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pageData),
    });
    const data = await res.json();
    return data.success ? data.page : null;
  } catch (e) {
    console.error('Error creating page:', e);
    showToast('Failed to create page', 'error');
    return null;
  }
}

async function updatePage(slug, token, updates) {
  try {
    const res = await fetch(`${API_URL}/page/${slug}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...updates, adminToken: token }),
    });
    const data = await res.json();
    return data.success ? data.page : null;
  } catch (e) {
    console.error('Error updating page:', e);
    showToast('Failed to update page', 'error');
    return null;
  }
}

async function deletePage(slug, token) {
  try {
    const res = await fetch(`${API_URL}/page/${slug}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ adminToken: token }),
    });
    const data = await res.json();
    return data.success;
  } catch (e) {
    console.error('Error deleting page:', e);
    showToast('Failed to delete page', 'error');
    return false;
  }
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function genSlug(title) {
  const base = (title || 'page').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g,'') || 'page';
  return `${base}-${Math.random().toString(36).slice(2,7)}`;
}
function sanitizeSlug(inp) {
  inp.value = inp.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
}
function publicUrl(slug) { return `${BASE_URL}#/page/${slug}`; }
function adminUrl(slug, token) { return `${BASE_URL}#/admin/${slug}/${token}`; }
function nowStr() {
  return new Date().toLocaleString('en-US', { month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

// ‚îÄ‚îÄ‚îÄ ROUTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseHash() {
  const hash = window.location.hash;
  if (!hash || hash === '#' || hash === '#/') return { route: 'dashboard' };
  const parts = hash.replace(/^#\//, '').split('/');
  if (parts[0] === 'page' && parts[1]) return { route: 'public', slug: parts[1] };
  if (parts[0] === 'admin' && parts[1] && parts[2]) return { route: 'admin', slug: parts[1], token: parts[2] };
  return { route: 'dashboard' };
}

async function handleRoute() {
  const r = parseHash();

  if (r.route === 'public') {
    const page = await fetchPage(r.slug);
    if (!page) {
      showToast('Page not found', 'error');
      showDashboard();
      return;
    }
    renderPublicView(page);
    return;
  }

  if (r.route === 'admin') {
    const page = await fetchPageWithAuth(r.slug, r.token);
    if (!page) {
      showToast('Invalid or expired admin link', 'error');
      showDashboard();
      return;
    }
    openEditWithAuth(page, r.token);
    return;
  }

  showDashboard();
}

window.addEventListener('hashchange', handleRoute);

// ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideAllViews() {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
}

async function showDashboard() {
  hideAllViews();
  document.querySelector('nav').style.display = 'flex';
  document.getElementById('view-dashboard').classList.add('active');
  await fetchPages();
  renderGrid();
  setNav('dashboard');
  history.replaceState(null, '', window.location.pathname);
}

function goHome() { showDashboard(); }

function setNav(mode) {
  const nav = document.getElementById('nav-actions');
  if (mode === 'dashboard') {
    nav.innerHTML = `<button class="btn-primary" onclick="openNew()">+ New Page</button>`;
  } else if (mode === 'editor') {
    nav.innerHTML = `
      <button class="btn-ghost" onclick="goHome()">‚Üê Dashboard</button>
      <button class="btn-ghost" onclick="previewFromEditor()">Preview</button>
      <button class="btn-primary" onclick="savePageFromEditor()">${editingId ? 'Update' : 'Publish'}</button>`;
  }
}

function renderPublicView(page) {
  hideAllViews();
  document.getElementById('view-public').classList.add('active');
  document.getElementById('public-frame').srcdoc = page.html;
  document.querySelector('nav').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGrid() {
  const grid = document.getElementById('pages-grid');
  grid.innerHTML = '';

  if (pages.length === 0) {
    grid.innerHTML = `
      <div class="empty-state" style="grid-column:1/-1">
        <div class="icon">‚óá</div>
        <h3>No pages yet</h3>
        <p>Create your first HTML page and share it with the world</p>
        <button class="btn-primary" onclick="openNew()">Create First Page</button>
      </div>`;
    return;
  }

  pages.forEach((page, i) => {
    const card = document.createElement('div');
    card.className = 'page-card';
    card.style.animationDelay = `${i * 0.05}s`;

    const pubUrl = publicUrl(page.slug);

    card.innerHTML = `
      <div class="card-preview" onclick="openPreviewById('${page.id}')">
        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:48px;color:#222;">üìÑ</div>
        <div class="card-preview-overlay"></div>
      </div>
      <div class="card-body">
        <div class="card-title-row">
          <div class="card-title">${escHtml(page.title)}</div>
        </div>
        <div class="url-block">
          <div class="url-row">
            <span class="url-text" title="${escHtml(pubUrl)}">${escHtml(pubUrl)}</span>
            <button class="copy-btn" onclick="copyText('${escHtml(pubUrl)}', this)">Copy</button>
          </div>
        </div>
        <div class="card-footer-btns">
          <button class="btn-ghost" onclick="window.open('${escHtml(pubUrl)}', '_blank')">View</button>
        </div>
        <div class="card-date">Updated ${escHtml(page.updatedAt)}</div>
      </div>`;
    grid.appendChild(card);
  });

  const addCard = document.createElement('div');
  addCard.className = 'add-card';
  addCard.onclick = openNew;
  addCard.innerHTML = `<div class="plus">+</div><span>New Page</span>`;
  grid.appendChild(addCard);
}

// ‚îÄ‚îÄ‚îÄ EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNew() {
  editingId = null;
  editingToken = null;
  document.getElementById('editor-heading').textContent = 'Create New Page';
  document.getElementById('editor-subheading').textContent = 'Paste or upload HTML, set a URL slug, then publish.';
  document.getElementById('inp-title').value = '';
  document.getElementById('inp-slug').value = '';
  document.getElementById('html-input').value = '';
  document.getElementById('btn-save').textContent = 'Publish Page';
  document.getElementById('admin-key-box').classList.remove('show');
  document.getElementById('slug-prefix').textContent = window.location.host + '/';
  hideAllViews();
  document.getElementById('view-editor').classList.add('active');
  setNav('editor');
}

function openEditWithAuth(page, token) {
  editingId = page.id;
  editingToken = token;
  document.getElementById('editor-heading').textContent = 'Edit Page';
  document.getElementById('editor-subheading').textContent = `Editing: ${page.title}`;
  document.getElementById('inp-title').value = page.title;
  document.getElementById('inp-slug').value = page.slug;
  document.getElementById('html-input').value = page.html;
  document.getElementById('btn-save').textContent = 'Update Page';
  document.getElementById('admin-key-box').classList.remove('show');
  document.getElementById('slug-prefix').textContent = window.location.host + '/';
  hideAllViews();
  document.getElementById('view-editor').classList.add('active');
  setNav('editor');
}

async function savePageFromEditor() {
  const title = document.getElementById('inp-title').value.trim();
  const html = document.getElementById('html-input').value.trim();
  const slugIn = document.getElementById('inp-slug').value.trim();

  if (!html) { showToast('Please add HTML content', 'error'); return; }
  if (!title) { showToast('Please add a page title', 'error'); return; }

  const slug = slugIn || genSlug(title);
  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = editingId ? 'Updating...' : 'Publishing...';

  try {
    if (editingId) {
      const updated = await updatePage(slug, editingToken, { title, html, newSlug: slug });
      if (updated) {
        showToast('Page updated! üéâ');
        showAdminKeyBox(updated.slug, updated.adminToken);
        editingId = updated.id;
        editingToken = updated.adminToken;
      }
    } else {
      const created = await createPage({ title, slug, html, createdAt: nowStr(), updatedAt: nowStr() });
      if (created) {
        showToast('Page published! üéâ');
        showAdminKeyBox(created.slug, created.adminToken);
        editingId = created.id;
        editingToken = created.adminToken;
      }
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Update Page';
  }
}

function showAdminKeyBox(slug, token) {
  const box = document.getElementById('admin-key-box');
  document.getElementById('akb-public').textContent = publicUrl(slug);
  document.getElementById('akb-admin').textContent = adminUrl(slug, token);
  box.classList.add('show');
  box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ‚îÄ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openPreviewById(id) {
  const page = pages.find(p => p.id === id);
  if (!page) return;
  const fullPage = await fetchPage(page.slug);
  if (!fullPage) return;
  
  previewPageId = id;
  document.getElementById('preview-title-label').textContent = fullPage.title;
  document.getElementById('preview-url-label').textContent = publicUrl(fullPage.slug);
  document.getElementById('browser-url').textContent = publicUrl(fullPage.slug);
  document.getElementById('preview-frame').srcdoc = fullPage.html;
  document.getElementById('btn-edit-from-preview').style.display = 'none';
  hideAllViews();
  document.getElementById('view-preview').classList.add('active');
  setNav('preview');
}

function previewFromEditor() {
  const html = document.getElementById('html-input').value;
  const title = document.getElementById('inp-title').value || 'Preview';
  const slug = document.getElementById('inp-slug').value || 'preview';
  previewPageId = null;
  document.getElementById('preview-title-label').textContent = title;
  document.getElementById('preview-url-label').textContent = publicUrl(slug);
  document.getElementById('browser-url').textContent = publicUrl(slug);
  document.getElementById('preview-frame').srcdoc = html;
  document.getElementById('btn-edit-from-preview').style.display = 'none';
  hideAllViews();
  document.getElementById('view-preview').classList.add('active');
  setNav('preview');
}

// ‚îÄ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function readFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('html-input').value = e.target.result;
    const t = document.getElementById('inp-title');
    if (!t.value) t.value = file.name.replace(/\.html?$/i, '');
    showToast('File loaded!');
  };
  reader.readAsText(file);
}
function onFileSelect(e) { readFile(e.target.files[0]); }
function onDragOver(e) { e.preventDefault(); document.getElementById('dropzone').classList.add('drag-over'); }
function onDragLeave() { document.getElementById('dropzone').classList.remove('drag-over'); }
function onDrop(e) { e.preventDefault(); document.getElementById('dropzone').classList.remove('drag-over'); readFile(e.dataTransfer.files[0]); }

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyText(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('copied'); }, 1800);
  });
}

let toastTimer;
function showToast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 3000);
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function closeModal() { document.getElementById('confirm-modal').classList.remove('show'); }

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
handleRoute();
</script>
</body>
</html>

